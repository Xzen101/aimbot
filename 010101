--// GODLOCK v20 - Optimized Loops (RenderStepped replaced, lower updates, safer for ping)
--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

--// SETTINGS
local Settings = {
    Aimbot = false,
    WallCheck = false,
    ESP = false,
    FOV = 200,
    ESPRange = 1000,
    LockPart = "Head",
    TeamCheckAimbot = true,
    ESPTeamCheck = true,
    AimYOffset = 0,
    AimLerp = 0.95
}

--// STATE
local targetPart = nil
local lastUpdate = 0
local updateInterval = 0.06 -- safer update interval (~16/sec)
local playerList = {}
local espTable = {}
local centerScreen = Vector2.new(0,0)
local ignoreList = {}

--// PLAYER CACHE
local function updatePlayerCache()
    playerList = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(playerList, plr)
        end
    end
end
updatePlayerCache()
Players.PlayerAdded:Connect(updatePlayerCache)
Players.PlayerRemoving:Connect(updatePlayerCache)

--// UTILITIES
local function getLockPart(char)
    return char:FindFirstChild(Settings.LockPart) or char:FindFirstChild("Head") or char:FindFirstChild("UpperTorso")
end

local function isEnemy(plr, forAimbot)
    local check = forAimbot and Settings.TeamCheckAimbot or Settings.ESPTeamCheck
    if not check then return true end
    if not LocalPlayer.Team or not plr.Team then return true end
    return LocalPlayer.Team ~= plr.Team
end

local function isVisible(part)
    if not Settings.WallCheck then return true end
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = ignoreList
    local result = Workspace:Raycast(Camera.CFrame.Position, (part.Position - Camera.CFrame.Position).Unit * 500, params)
    return result and result.Instance:IsDescendantOf(part.Parent)
end

local function getTarget()
    local closest, shortest = nil, math.huge
    for _, plr in ipairs(playerList) do
        local char = plr.Character
        if char then
            local hum = char:FindFirstChild("Humanoid")
            if hum and hum.Health > 0 and isEnemy(plr,true) then
                local part = getLockPart(char)
                if part and isVisible(part) then
                    local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                    if onScreen then
                        local dist = (Vector2.new(pos.X,pos.Y) - centerScreen).Magnitude
                        if dist <= Settings.FOV and dist < shortest then
                            shortest = dist
                            closest = part
                        end
                    end
                end
            end
        end
    end
    return closest
end

--// ESP
local function makeESP(plr)
    if espTable[plr] then return end
    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Color = Color3.fromRGB(255,0,0)
    local line = Drawing.new("Line")
    line.Thickness = 1
    line.Color = Color3.fromRGB(255,0,0)
    espTable[plr] = {box = box, line = line}
end

for _, p in ipairs(playerList) do makeESP(p) end
Players.PlayerAdded:Connect(function(p)
    if p ~= LocalPlayer then makeESP(p) end
end)
Players.PlayerRemoving:Connect(function(p)
    local esp = espTable[p]
    if esp then
        esp.box:Remove()
        esp.line:Remove()
        espTable[p] = nil
    end
end)

--// LOOP OPTIMIZATION
task.spawn(function()
    while true do
        local cam = Camera
        if not cam then task.wait(0.1) continue end

        centerScreen = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y/2)
        ignoreList = {LocalPlayer.Character or {}}

        targetPart = getTarget()

        -- AIMBOT
        if Settings.Aimbot and targetPart then
            local pos = targetPart.Position + Vector3.new(0,Settings.AimYOffset,0)
            cam.CFrame = cam.CFrame:Lerp(CFrame.lookAt(cam.CFrame.Position, pos), Settings.AimLerp)
        end

        -- FOV Circle
        if fovCircle then
            fovCircle.Position = centerScreen
            fovCircle.Radius = Settings.FOV
            fovCircle.Visible = Settings.Aimbot
        end

        -- ESP
        if Settings.ESP then
            for plr, esp in pairs(espTable) do
                local char = plr.Character
                if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 and isEnemy(plr,false) then
                    local root = getLockPart(char)
                    if root and (cam.CFrame.Position - root.Position).Magnitude <= Settings.ESPRange then
                        local rootPos, onScreen = cam:WorldToViewportPoint(root.Position)
                        if onScreen then
                            local headPos = cam:WorldToViewportPoint((char.Head or root).Position)
                            local h = math.abs(rootPos.Y - headPos.Y)
                            local w = h/2
                            esp.box.Visible = true
                            esp.box.Size = Vector2.new(w,h)
                            esp.box.Position = Vector2.new(rootPos.X - w/2, math.min(rootPos.Y, headPos.Y))
                            esp.line.Visible = true
                            esp.line.From = Vector2.new(centerScreen.X, cam.ViewportSize.Y)
                            esp.line.To = Vector2.new(rootPos.X, rootPos.Y)
                        else
                            esp.box.Visible = false
                            esp.line.Visible = false
                        end
                    else
                        esp.box.Visible = false
                        esp.line.Visible = false
                    end
                else
                    esp.box.Visible = false
                    esp.line.Visible = false
                end
            end
        else
            for _, esp in pairs(espTable) do
                esp.box.Visible = false
                esp.line.Visible = false
            end
        end

        task.wait(updateInterval)
    end
end)

--// INIT
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    updatePlayerCache()
end)

print("GODLOCK v20 LOADED - Optimized Loop (~16x/sec), Fixed ESP Freeze, Hard Lock Aimbot (0.95 Lerp)")
